name: Validate PR Structure

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check event folder structure
        run: |
          ERRORS=0
          WARNINGS=0

          # Get list of changed files
          git fetch origin ${{ github.base_ref }} --depth=1
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check event folder naming convention
          for dir in $(echo "$CHANGED" | grep '^events/' | cut -d'/' -f1-4 | sort -u); do
            if [[ "$dir" =~ ^events/[0-9]{4}/[0-9]{2}/[0-9]{4}-[0-9]{2}-[0-9]{2}-.+ ]]; then
              EVENT_DIR="$dir"

              # Check event README exists
              if [[ ! -f "${EVENT_DIR}/README.md" ]]; then
                echo "::error::Missing README.md in ${EVENT_DIR}"
                ERRORS=$((ERRORS + 1))
              fi
            elif [[ "$dir" =~ ^events/[0-9]{4}/[0-9]{2}$ ]] || [[ "$dir" =~ ^events/[0-9]{4}$ ]] || [[ "$dir" == "events" ]]; then
              : # year/month directories are fine
            elif [[ "$dir" == "events/README.md" ]]; then
              : # events README is fine
            else
              echo "::error::Event folder doesn't match YYYY-MM-DD-city pattern: $dir"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check file sizes (2MB limit)
          for file in $CHANGED; do
            if [[ -f "$file" ]]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
              if [[ $SIZE -gt 2097152 ]]; then
                echo "::error::File exceeds 2MB limit: $file ($(($SIZE / 1048576))MB)"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          echo ""
          echo "Validation complete: $ERRORS error(s), $WARNINGS warning(s)"

          if [[ $ERRORS -gt 0 ]]; then
            exit 1
          fi
